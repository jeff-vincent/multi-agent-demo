name: Dev Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: "registry:5000"
  TAG: "${{ github.actor }}-${{ github.sha }}"

jobs:
  build-and-deploy:
    runs-on: [self-hosted, "${{ github.actor }}"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean builds directory
        shell: bash
        run: |
          rm -f /builds/*.done /builds/*.request /builds/*.processing \
                /builds/*.apply /builds/*.apply-done /builds/*.apply-log \
                /builds/*.apply-exitcode /builds/*.exitcode \
                /builds/*.log /builds/*.dest /builds/*.tar.gz \
                /builds/*.yaml /builds/*.sh

      # -- Build all images --

      - name: Build agent image
        uses: kindling-sh/kindling/.github/actions/kindling-build@main
        with:
          name: agent
          context: ${{ github.workspace }}
          dockerfile: agent/Dockerfile
          image: "${{ env.REGISTRY }}/agent:${{ env.TAG }}"

      - name: Build orchestrator image
        uses: kindling-sh/kindling/.github/actions/kindling-build@main
        with:
          name: orchestrator
          context: ${{ github.workspace }}
          dockerfile: orchestrator/Dockerfile
          image: "${{ env.REGISTRY }}/orchestrator:${{ env.TAG }}"

      # -- Deploy in dependency order --

      - name: Deploy agent
        uses: kindling-sh/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-agent"
          image: "${{ env.REGISTRY }}/agent:${{ env.TAG }}"
          port: "8000"
          ingress-host: "${{ github.actor }}-agent.localhost"
          health-check-type: "none"
          labels: |
            app.kubernetes.io/part-of: multi-agent-demo
            app.kubernetes.io/component: agent
            apps.example.com/github-username: ${{ github.actor }}
          env: |
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: kindling-secret-openai-api-key
                  key: OPENAI_API_KEY
            - name: REDIS_HOST
              value: "${{ github.actor }}-agent-redis"
            - name: REDIS_PORT
              value: "6379"
          dependencies: |
            - type: redis

      - name: Deploy orchestrator
        uses: kindling-sh/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-orchestrator"
          image: "${{ env.REGISTRY }}/orchestrator:${{ env.TAG }}"
          port: "8000"
          ingress-host: "${{ github.actor }}-orchestrator.localhost"
          health-check-type: "none"
          labels: |
            app.kubernetes.io/part-of: multi-agent-demo
            app.kubernetes.io/component: orchestrator
            apps.example.com/github-username: ${{ github.actor }}
          env: |
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: kindling-secret-openai-api-key
                  key: OPENAI_API_KEY
            - name: REDIS_HOST
              value: "${{ github.actor }}-orchestrator-redis"
            - name: REDIS_PORT
              value: "6379"
          dependencies: |
            - type: redis
